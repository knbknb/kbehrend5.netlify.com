---
title: Blood Pressure in the US population
author: Knut Behrends
date: '2018-02-08'
slug: bloodpressure-nhanes
categories: [health, rstats]
tags: [rstats]
draft: no
output:
  html_document:
    toc: no
    css: styles.css
    fig_caption: yes
    keep_md: no
image: /static/img/football.png
banner: img/post/thumb/football.png
summary: 'Blood Pressure in Americans, two different datasets.'
keywords:
  - Personal-Blog
  - Fun
  - rstats
  - blood-pressure
  - Health
  - Open-data
---


```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, 
               echo = FALSE, tidy = FALSE, width = 7, fig.width=7)
options(digits = 3, tibble.print_min = 6)
options(knitr.table.format = "html") 
```

#### Blood Pressure as a function of age and body weight


```{r abstr, echo=FALSE}
htmltools::HTML('<div class="alert alert-info"><b>Very basic analysis of two health datasets from ~ 2010, about the  general US Population.</b>
                The data were gathered independently. One of them is a tiny teaching dataset, the other is a large study. Both datasets show that systolic blood pressure rises about 5-10 mm Hg per decade. </div>')
```

Conversations with friends and colleagues  kept me  thinking about blood pressure lately.
Then I've remembered that weekend project from late 2017. Back then I had analysed two datasets:   one available on the internet, the other available as R package NHANES on CRAN. 
My motivation in writing this up was half learning *ggplot*, half gaining insights from data by moving from a small teaching dataset to a messy, much larger dataset from a real medical study.

Load the necessary packages. Nothing fancy here.

```{r pkgs}
library(readxl)
library(tidyverse)
theme_set(theme_bw())
```

Download **dataset 1**: A tiny 11x4 table called `Systolic Blood Pressure`. It comes from [a book publisher's website.](http://college.cengage.com/mathematics/brase/understandable_statistics/7e/students/datasets/mlr/frames/frame.html). Maybe it is a teaching dataset, perhaps supplementary material for a college textbook.

The [markdown version  of this blog post](https://github.com/knbknb/kbehrends.netlify.com/tree/master/content) contains the necessary instructions on how to download and import the data.

```{r IOstuff, echo=FALSE}
xlsurl <- "http://college.cengage.com/mathematics/brase/understandable_statistics/7e/students/datasets/mlr/excel/mlr02.xls"
xls <- basename(xlsurl)
folder <- "data_private"
destfile <- here::here(file.path(folder, xls))
destfile2 <- here::here(file.path(folder, "mlr02.csv"))

if (!file.exists(destfile)) {
  download.file(xlsurl, destfile = destfile, method = "curl")
  xlstmp <- read_xls(destfile)
  # col1 = systolic blood pressure
  # col2 = age in years
  # col3 = weight in pounds
  # TODO: document how converted to csv
}
# read in a properly formatted csv file
bloodpressure <- read_csv(destfile2, col_names = TRUE)
# Convert bodyweights from pounts to kilograms:
bloodpressure <- bloodpressure %>%
  mutate(weight = weight_pounds * 0.453592)

```

The dataset is tiny:

```{r ds1, echo=FALSE}
glimpse(bloodpressure)
```

```{r echo=FALSE, eval=FALSE}
# The summary takes up more room than the data itself.
summary(bloodpressure)
```

We can plot it in its entirety. I also fit a simple linear regression mode to the data. Blood Pressure as a function of a person's age and body weight.
```{r tiny1,  results='hide'}
bloodpressure_model <- lm(blood_pressure ~ age + weight, data = bloodpressure)


# predict blood pressure using bloodpressure_model :prediction
bloodpressure$prediction <- predict(bloodpressure_model, data = bloodpressure)


```

Adding the predictions from the model:

```{r tiny2, echo=FALSE, fig.cap=" Predicted values are shown in red."}

ggplot(bloodpressure, aes(age, blood_pressure)) +
  geom_point() +
  geom_smooth(method="lm") +
  geom_point(aes(age, prediction), color = "red", size = 1) +
        ggtitle("Blood pressure as a function of age.", subtitle="Systolic Blood pressure [mm Hg]")+
        xlab("Age/years") + ylab("")

```

The linear regression model shows a strong correlation with age. 

```{r}
summary(bloodpressure_model)

```

The  model predicts that for every year of one's life the systolic pressure increases  `r coef(bloodpressure_model)[2]` mm Hg/year. That's almost **10 mm Hg per decade**! Quite a lot. Is this realistic? Or  is this a fictitious dataset? Is the trend correct, but the value is not? In other words, is the sample nonrepresentative of the population? Is there a confounding factor? We haven't looked at body weight yet!

Let's try a larger dataset!

#### NHANES dataset


The NHANES dataset is available as an R package on CRAN. It contains data from the US **N**ational **H**ealth **a**nd **N**utrition **E**xamination **S**tudy. I have used package version 2.1.0, specifically "NHANES 2009-2012 with adjusted weighting". This dataset contains some corrections for undersampling racial minorities. Uncorrected data is also available in the NHANESraw package.

See [http://www.cdc.gov/nchs/nhanes.htm](http://www.cdc.gov/nchs/nhanes.htm) for details.

```{r}
library(NHANES) # Body Shape and related measurements from 10000 US citizens
data(NHANES)

```

The dataset is big, very big. It contains `r nrow(NHANES)` rows and `r ncol(NHANES)` columns, so even listing all of them here would waste too much screen space. I'll concentrate on the relevant columns here.

#### Column names containing "Age":

```{r}

ages <- names(NHANES) %>% str_which("Age")
names(NHANES)[ages]

```
#### Column names containing "Weight":
```{r}
weights <- names(NHANES) %>% 
        str_detect(pattern=regex("weight", ignore_case = TRUE))
names(NHANES)[weights]

```

```{r wghtm, eval=FALSE}
# Column names containing "Weight":
bmi <- names(NHANES) %>% str_which(regex("BMI", ignore_case = TRUE))
names(NHANES)[bmi]

```

#### Column names containing the prefix "BP" (Blood Pressure):

```{r press}
pressures <- names(NHANES) %>% str_which("BP")
names(NHANES)[pressures]

```

 Create a smaller NHANES dataset, `bloodpressure2`, containing relevant columns only: 

```{r echo=TRUE}
bloodpressure2 <- NHANES %>%
    select(BPSys1, Age, Weight, Gender, BMI) %>%
    filter(!is.na(BPSys1))

```

The dataset contains `r nrow(bloodpressure2)` rows (People) and `r ncol(bloodpressure2)` columns.

Summary of Blood Pressure Data:

```{r}
summary(bloodpressure2)
```


#### Blood Pressure by Gender:

```{r}

bloodpressure2 %>%
        ggplot(aes(BPSys1, color=Gender, fill=Gender)) +
        geom_histogram(binwidth = 1) +
        xlab("Systolic Blood Pressure [mm Hg]") + ylab("") +
        ggtitle("", subtitle = "Number of People") +
        facet_grid(. ~ Gender ) +
        theme(legend.position = "none")

```


Focus on the 19-year old Americans. How healthy is this subgroup? There are lots of participants at this age, and they are grown-ups. We can assume they themselves are  in charge of their own bodies.

Tabulate the 19-year-olds: 

```{r table1}
bloodpressure2 %>%
        filter(Age >= 19, Age < 20) %>%
        select(Gender) %>%
        table( )

```

For each year of age, there are about 100 participants in the study.

```{r plot3a, eval=FALSE}
Median values:

(medians <- bloodpressure2 %>%
        select(BMI, Gender) %>%
                rename("19-year-olds" = Gender) %>%
        group_by(`19-year-olds`) %>%
        summarise(median_BMI = median(BMI, na.rm = TRUE)) )
#By the way, 19-year-old Americans are quite fat.

```


```{r plot3BMI, eval=FALSE }

medians <- medians %>%
        select(median_BMI) %>%
        unlist()

ggplot(bloodpressure2, aes(BMI, fill=Gender)) +
        geom_histogram(alpha=0.3, binwidth=1, position="identity") +
        geom_vline(xintercept = medians, alpha = 0.2 )

```

#### Blood Pressure by Age Group

After splitting the dataset by decade, we get this:

```{r plot4, fig.height=12}
bloodpressure2 %>%
        ggplot(aes(BPSys1)) +
        geom_histogram(binwidth = 1) +
        facet_wrap(~cut_interval(x = Age, length = 10), ncol=1) +
        ggtitle("Blood Pressure by decade", subtitle="Number of People") +
        xlab("Systolic Blood Pressure [mm Hg]")

```


Fit a linear regression model to the entire `bloodpressure2` subset, just as above for the tiny dataset. 

```{r}
# Fit the model: bloodpressure_model
bloodpressure2_model <- lm(BPSys1 ~ Age, data = bloodpressure2)

# predict blood pressure using bloodpressure_model :prediction
bloodpressure2$prediction <- predict(bloodpressure2_model, data = bloodpressure2)

```
```{r}
summary(bloodpressure2_model)

```

```{r fig.cap="Small gaps are created on purpose to avoid overplotting."}
ggplot(bloodpressure2, aes(prediction, BPSys1)) +
  geom_jitter(size=0.1, alpha=0.4) +
  geom_abline(color = "blue") +
        xlim(c(90, 150)) +
        ylim(c(90, 150)) +
        ggtitle("Predicted vs Actual Blood Pressure",
                subtitle = "mm Hg")


```

```{r}
###############################################

# Age-related plots
ggplot(bloodpressure2, aes(Age, BPSys1)) +
  geom_jitter(size=0.1, alpha=0.4) +
  geom_point(aes(Age, prediction), color = "red", size = 0.2)

```

#### Boxplots of 10-year age groups

```{r plot8}
ggplot(bloodpressure2, aes(cut_interval(x = Age, length = 10), BPSys1)) +
  #geom_boxplot(varwidth = TRUE,  outlier.shape = NA) +
  geom_violin(alpha = 0.1, aes(color = Gender), size=0.5) +
  theme(legend.position = "none") +
  stat_summary(fun.data = "mean_cl_normal",
               geom = "crossbar",
               width = 0.2,
               col = "red") +
  scale_y_continuous(limits = c(50, 250), breaks = seq(50, 250, 25), minor_breaks = seq(50, 250, 5)) +
        theme(axis.text.x = element_text(angle=60)) +
  xlab("Age group [years]") +
  ylab("Blood Pressure [mmHg]") +
  ggtitle("Blood Pressure of 8200 Americans", subtitle = "Systolic Blood Pressure [mmHg] by age group. NHANES Dataset, 2009-2012.") +
  facet_grid(. ~ Gender )


```

#### To be continued.

```{r}
htmltools::HTML('<div class="alert alert-info"><b>What I learned from doing this</b>
<ul>
<li> Gaining insights by switching from a tiny to a big dataset.
<li> New tricks with ggplot2
<li> Splitting continuous data into categories / age classes was really helpful here
    </ul>
</div>')
```
