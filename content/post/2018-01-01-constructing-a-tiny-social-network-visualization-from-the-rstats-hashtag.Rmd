---
title: 'Constructing a tiny social-network visualization from the #Rstats hashtag'
author: Knut Behrends
date: '2018-01-01'
slug: constructing-a-tiny-social-network-visualization-from-the-rstats-hashtag
categories: [blog-post]
tags: [fun, rstats]
banner: img/post/thumb/rstats_tweetnodes.png
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# (Under Construction - Checking if 3-D plot below works )


In 2016, I was harvesting tweets from the Twitter streaming API. I've used the `#rstats` hashtag as the search filter. This hashtag is commonly used by the R community on Twitter. Tag `#rstats` is more descriptive than the too short, unusable, `#R` hashtag which may not even be a valid filter expression.

Here I do some exploratory analysis of these ~ 1000 tweets, and I visualize the interactions (the "mentions") of the active Twitter users as a directed graph.

####  Preprocessing

Load the necessary R packages, and the datafiles. 

```{r libs, warning=FALSE, message=FALSE}
options(knitr.table.format = "html") 
library(here)
library(stringr)
library(lubridate)
library(threejs)
library(tidyverse)
library(igraph)

datadir <- "data/twitter"
# (extracts from the full tweets data, explained below)
infile0 <- here::here(datadir, "rstats_tweettimes.txt")
infile1 <- here::here(datadir, "rstats_network.txt")

```

Convert dates to strings, group them into day-of-month, and hours-of-day:

```{r dates,  echo=FALSE, results='hide'}
tweetdates <- read_csv(infile0)
# rstats_tweettimes.txt:  "Sun Jul 10 08:14:23 +0000 2016"
tweetdates <- tweetdates %>% 
        mutate(dt = str_replace(dt, "\\+0000 ", ""),
               dt = str_replace(dt, "^\\w+ ", ""),
               dt = parse_date_time(dt, orders = c("b d  H:M:S Y")),
               day = day(dt),
               day = sprintf("July %02d", day),
               hour = hour(dt))

```

From `r min(tweetdates$dt)` to `r max(tweetdates$dt)` I gathered `r nrow(tweetdates)` tweets, encoded in JSON format.  
Each tweet contains about 2500 characters. This might surprise you, because a tweet used to be 140 characters in length, until Twitter increased it to 280 characters in 2017. But a tweet contains a lot of metadata, and this makes a tweet exceed 2000 characters, when serialized to a compact JSON string (*not* pretty-printed).

In a different blogpost ('[Learning jq](/post/2017/12/learning-jq)')  I've explained how to extract specific fields from the nested structure. See example 4.

#### Plot: Activity over time

This plot shows  the user activity during this 3-day period:

```{r plot1, fig.width=9}
theme_set(theme_bw())
tweetdates %>% ggplot(aes(hour)) +
  geom_bar(fill="dodgerblue") +
        facet_wrap(~ day, nrow = 1) +
        xlab("Hour of Day")+ ylab("Tweets per Hour") +
        ggtitle("#Rstats Tweets in July 2016", 
                subtitle = "Harvested from the Twitter Streaming API. Local Time Zone: Central European Time.")
```

Currently I have not looked at the peak that happened on July 09 2016 at ~ 15:00 h.

#### Constructing the interactions network 

The text file with the user data and the important "mentions" metadata can be read in as a data frame:

```{r message=FALSE, warning=FALSE}
mentions <- read_csv(infile1)
# remove leading "_" from column names
colnames(mentions) <- gsub("^_", "", colnames(mentions), perl = TRUE)
```

Convert it to an igraph object `gr`, a network:

```{r df2igr}
users <- mentions %>% 
        select(name) %>% 
        dplyr::union(mentions %>% 
                             select(mentions_name) %>% 
                             rename(name ="mentions_name"))


gr <- mentions %>% 
        select(name, mentions_name) %>%
        unique() %>% 
        filter(name != mentions_name) %>% 
        graph_from_data_frame(directed = TRUE, vertices = users)

gr <- set_vertex_attr(gr, "color", value = "dodgerblue")

# Redraw the graph and make the vertex size 1

ec <- as.numeric(eigen_centrality(gr)$vector)

# Create new vector 'v' that is equal to the square-root of 'ec' 
# multiplied by some scaling factor, here: 2
v <- 2 * sqrt(ec)


```

#### Plot: The network 

```{r plot2, fig.width=9}
# Plot threejs plot of graph setting vertex size to v
graphjs(gr, vertex.size = v, vertex.label = TRUE, 
        main="#Rstats tweet network, ~1 day in July 2016")

```

**Move the mouse pointer over the plot and press the left button, then drag the mouse pointer around. Mouse wheel enlarges.**

I suspect the Hadley Wickham node sits at the center of the large cluster with the large nodes.



```{r moreplots, eval=FALSE, echo=FALSE}
g.b <- betweenness(gr, directed = TRUE)
#Show histogram of vertex betweenness
hist(g.b, breaks = 80)


plot(gr,
     vertex.label = NA,
     vertex.label.color = "black", 
     edge.color = 'gray77',
     vertex.size = 0,
     edge.arrow.size = 0.1,
     layout = layout_nicely(gr))

# Create plot with vertex size determined by betweenness score
plot(gr, 
#     vertex.label = NA,
     edge.color = 'black',
     vertex.size = sqrt(g.b)+1,
     edge.arrow.size = 0.05,
     layout = layout_nicely(gr))
```

Show some details of the network, in textual form:

```{r}
incident(gr, 'Hadley Wickham', mode = c("all")) %>%  head(20)
```

#### Coming soon: 
 
 - Labels on the network nodes.
 - A note on the peak of activity on July 09 2016 at ~ 15:00
 - Analysis of a larger twitter dataset (about a different subject)
 
**Stay tuned!**