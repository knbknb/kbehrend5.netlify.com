---
title: Lasso regression on Blood Pressure data
author: Knut Behrends
date: '2018-02-13'
slug: bloodpressure-lasso
categories: [health]
tags: [health, medicine]
draft: yes
output:
  html_document:
    toc: no
    css: styles.css
    fig_caption: yes
    keep_md: no
image: /static/img/hugo-gopher.png
banner: img/post/thumb/hugo-logo.png
summary: ''
keywords:
  - Personal-Blog
  - Fun
  - rstats
  - health
---


```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, 
               echo = FALSE, tidy = FALSE, width = 7, fig.width=9)
options(digits = 3, tibble.print_min = 6)
options(knitr.table.format = "html") 
library(kableExtra)
```
```{r pkgs1}
library(NHANES) # Body Shape + related measurements from 10000 US citizens
data(NHANES)
library(rvest)
library(tidyverse)
library(ggthemes)
library(mice)  # imputation
theme_set(theme_bw())
scale_colour_discrete <- function(...) scale_color_brewer(palette="Set1")

```

#### Lasso Regression on Blood Pressure Data (NHANES Dataset)


```{r abstr, echo=FALSE}
htmltools::HTML('<div class="alert alert-info"><b>Performing Lasso Regression on anonymized data from 10000 people representing the general US Population</b>. Actually I will also try out other model selection techniques.
</div>')
```
This is a follow-up to [an exploratory data-analysis post](/post/2018/02/bloodpressure-nhanes) of mine. When I was nearly done with writing that post, some new questions came to my mind.

In the preceding blogpost I noticed that Systolic Blood Pressure is correlated with age and weight, but the relationship is complicated: the trend was noisy and the correlation was weak, and interaction term in the linear model seems to play an important role. 

Here I'll continue with exploratory analysis, so there is not really a new hypothesis. More basically, can I determine some other variables (out of the `r ncol(NHANES)`) that are also influencing the Blood Pressure in some way?

I am not trying to do groundbreaking medical research here. Hey I'm just a blogger, playing with a dataset for personal entertainment, trying out some of those fancy Machine Learning algorithms that I encountered during MOOC homework assignments. This time I'll try these techniques out on larger datasets that *I* find interesting.


#### NHANES dataset

NHANES is  the US National Health and Nutrition Examination Study. It is a carefully curated, larger medical survey aiming to get a representative sample of the general US population. The survey is carried out periodically.

The [*NHANES* dataset](https://www.cdc.gov/nchs/nhanes/participant_video.htm) is available as an R package on [CRAN](https://cran.r-project.org/package=NHANES). I have used package version 2.1.0, specifically "NHANES 2009-2012 with adjusted weighting". This dataset contains data from two collection periods, 2009-2010 and 2011-2012.

Obligatory Disclaimer (from the Package Documentation):

*Please note that the data sets provided in this package are derived from the NHANES database and have been adapted for educational purposes. As such, they are NOT suitable for use as a research database.*

#### Feature Engineering
These are  the column names and some other important metadata of the NHANES dataset. These metadata are, for example, the unique distinct values of columns where it makes sense to report them (e.g. male/female for column "gender") 


```{r names_defs}
x <- read_html(x = here::here("data_private/nhanes_datadict_raw.html"))
dls <- html_nodes(x, xpath="//dl") 
nhanes_defs = data.frame()
dl <- dls[[1]]
dts <- html_nodes(dl, xpath="//dt")  
dds <- html_nodes(dl, xpath="//dd")
nhanes_defs <- data_frame(
                  "Column" = dts %>% 
                           html_nodes(xpath='//dt')%>% html_text(),
                   "Meaning" = dds %>% html_nodes(xpath='//dd')%>% 
                           html_text() %>% str_trim() %>% 
                           str_replace_all("\t", " ") %>%  
                           str_replace("\"","")
                   )
```

```{r}

action1 <- "drop"
action2 <- "Yes/No"

nhanes_defs <- nhanes_defs %>%
        mutate(Action= case_when(
                # (str_detect(Meaning, "Yes") == TRUE)  & 
                #  str_detect(Meaning, "No") == TRUE ~ action2, 
                         Column == "ID" ~ action1,
                         Column == "AgeMonths" ~ action1,
                         Column == "AgeDecade" ~ action1,
                         Column == "Race3" ~ action1,
                         Column == "Education" ~ action1,
                         Column == "MaritalStatus" ~ action1,
                         Column == "Length" ~ action1,
                         Column == "HeadCirc" ~ action1,
                         Column == "MaritalStatus" ~ action1,
                         Column == "BMICatUnder20yrs" ~ action1,
                         Column == "BMI_WHO" ~ action1,
                         str_detect(Column, pattern=regex("^BP")) == TRUE &
                         str_detect(Column, pattern=regex("Ave")) == FALSE ~ action1,
                         Column == "nPregnancies" ~ action1,
                         Column == "nBabies" ~ action1,
                         Column == "PregnantNow" ~ action1,
                         Column == "Age1stBaby" ~ action1,
                         str_detect(Column, "WTINT2YR") == TRUE ~ action1,
                         Column == "WTMEC2YR" ~ action1,
                         Column == "SDMVPSU" ~ action1,
                         Column == "SDMVSTRA" ~ action1,
                         Column == "TVHrsDayChild" ~ action1,
                         Column == "CompHrsDayChild" ~ action1,
                 str_detect(Column, pattern=regex("TVHrs|CompHrs|AgeDecade")) == TRUE ~ action1,
                        
                         TRUE ~ ""))

```

```{r tabledef, cache=FALSE}

knitr::kable(nhanes_defs, row.names = 1, 
              caption = "Column names in NHANES data set,\
              and columns that will be dropped") %>% 
        kable_styling(bootstrap_options = 
                c("striped", "hover"))


```

```{r}

drop_cols <- nhanes_defs %>% 
        filter(Action == action1) %>% select(Column) %>%
        as_vector()

# factor_cols <- nhanes_defs %>% 
#         filter(Action == action2) %>% select(Column) %>% 
#         as_vector()
#dfr <- NHANES %>% select(Age, AgeDecade) %>% filter(is.na(AgeDecade))


```

More Feature Engineering Measures:

- Remove people less than 20 years of age
- Remove columns, marked as "drop" in table 1 (measured for child/youth-only, etc).
- Impute missing values with "mice" method (Multiple Imputation by Chain Equation)


```{r imputed}
NHANES <- NHANES %>% 
        filter(Age >= 20) %>% 
        select(setdiff(colnames(NHANES), drop_cols) )

NHimp <- "data_private/NHANES-imputed.rds"
if (!file.exists(NHimp)){
        imputed <- readRDS(here::here(NHimp))        
} else {
        imputed <- complete(mice(NHANES))
        saveRDS(imputed, file = here::here(NHimp))
}

# 
imputed <- imputed %>% 
        select(-AgeDecade, HHIncomeMid)

```

NHANES Data after Feature Engineering: no more NAs in any column.


```{r contents}
Hmisc::contents(imputed)
```



(TBC)



```{r htmltools}
htmltools::HTML('<div class="alert alert-info"><b>What I&apos; learned from doing this:</b>
<ul>
<li>Applied Model Selection techniques, a little bit more independently than before 
<li>Played a bit with the `ggvis` package, which generates vector graphics instead of SVGs 
</ul>
</div>')

```
