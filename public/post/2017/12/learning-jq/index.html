<!-- post/single.html //-->
<!DOCTYPE html>
<html lang="en-us">
        <!-- post/header_post.html //-->
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Learning jq</title>
<meta name="description" content="Knut Behrends&#39; personal blog. A website built through Hugo and blogdown.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">

<link rel="stylesheet" href="/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/owl.carousel.css">
<link rel="stylesheet" href="/css/owl.theme.css">


  <link href="/css/style.green.css" rel="stylesheet" id="theme-stylesheet">

 

  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  


<link href="/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="/img/favicon/favicon.png">


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-38728498-3', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>


    
<link rel="apple-touch-icon" sizes="57x57" href="/img/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/img/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/img/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/img/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/img/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/img/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/img/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/img/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/img/favicon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/img/favicon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">
<link rel="manifest" href="/img/favicon/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">

  </head>
  <body>
    <div class="wrapper">
      <header class="header">
              <nav class="nav">

  <a href="/" class="nav-logo">
    
    <span class="nav-logo-medium"><img src="/img/logo-knutbehrends-square-circle.72x72.png" alt="brain-activity-logo" /></span>
    
    </a>
  <span class="sidebar-heading">
          <a href="/">Knut Behrends Personal Blog, v3</a>
  </span>
  <ul class="nav-links">
    
    <li><a href="/">Home</a></li>
    
    <li><a href="/post/">Blog</a></li>
    
    <li><a href="/about/">About</a></li>
    
    <li><a href="/contact/">Get in touch</a></li>
    
  </ul>
</nav>

      </header>


<link rel="apple-touch-icon" sizes="57x57" href="/img/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/img/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/img/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/img/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/img/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/img/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/img/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/img/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/img/favicon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/img/favicon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">
<link rel="manifest" href="/img/favicon/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">




<link href='//cdn.bootcss.com/highlight.js/9.11.0/styles/github.min.css' rel='stylesheet' type='text/css' />




<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">3 min read</span>
    

    <h1 class="article-title">Learning jq</h1>

    
    <span class="article-date">2017/12/16</span>
    

    <div class="article-content">
      <div id="a-grabbag-of-commands" class="section level3">
<h3>A grabbag of <img src="/img/portfolio/jq-med.png" /> commands</h3>
<blockquote>
<p>Some notes about learning jq, the lightweight and flexible command-line JSON processor. Maybe I’ll extend and improve this blog post in the next months.</p>
</blockquote>
<p>I need to be fluent with the JSON parsing tool <a href="https://stedolan.github.io/jq/">jq</a>. Very often I have to interact with JSON data: When I interact with APIs, when parsing scraped Twitter data, when doing SPARQL queries…</p>
<p>Here I’ve saved some of my own mini-scripts and shortcuts that I have developed for my own needs. Most of it is already available in similar form, on the internet, but it is not available in a form that I found useful.</p>
<p>The following text snippets emerged by entering commands on the Unix command line. This was a trial and error process.</p>
<p>The format of the snippets below is a pipe of shell commands.</p>
<p><code>&lt;infile.json jq-cmd1 jq-cmd2 std-cmd1 std-cmd2 ...</code></p>
<p>The infile.json I’ve saved beforehand using a <a href="https://stackoverflow.com/a/47791375/202553">small python script</a>.</p>
<p>The infile contains one Tweet per line. The file as a whole is not a valid JSON file. For this reason I need the first <code>jq</code> command. It converts the collection of JSON fragments into an array of JSON objects and some transforming/filtering into another sequence of JSON fragments. The second <code>jq</code> command converts the transformed JSON into a csv file. This jq-cmd is so complex that I’ve factored out into a small file in the same directory, called <code>to_csv.jq</code>.</p>
<div id="example-1---extract-tweet-text" class="section level4">
<h4>Example 1 - extract tweet text</h4>
<p>This snippet extracts the text from a file that I created by saving data from the Twitter streaming API:</p>
<pre><code>&lt; raw_tweets/stream__AGU17.json jq -s &#39;[.[] | {text: .text}] &#39; \
   | jq  -f -r to_csv.jq  | grep -i &quot;rstats&quot; | sort -u</code></pre>
</div>
<div id="example-2---extract-more-than-1-field-from-tweets" class="section level4">
<h4>Example 2 - extract more than 1 field from Tweets</h4>
<p>This is a variant of Example 1. Extract 5 fields from different levels of the tweet into a csv file with brief column names.</p>
<pre><code>&lt;raw_tweets/stream_rstats.json jq  -s  -S  &#39;[.[] | \
   {name:  .user.name, sn: .user.screen_name, loc: .user.location, \
   url:.user.url, desc:.user.description, _fol: .user.followers_count }]&#39;   | \
   jq  -f -r to_csv.jq
</code></pre>
</div>
<div id="helper-function-to_csv" class="section level4">
<h4>Helper function <code>to_csv()</code></h4>
<p>This is from a <a href="https://stackoverflow.com/a/44012345/202553">Stackoverflow Answer</a> on the question <em>How to convert arbirtrary simple JSON to CSV using jq?</em></p>
<pre><code>
def tocsv($x):
    $x
    |(map(keys)
        |add
        |unique
        |sort
    ) as $cols
    |map(. as $row
        |$cols
        |map($row[.]|tostring)
    ) as $rows
    |$cols,$rows[]
    | @csv;

tocsv(.)

</code></pre>
</div>
<div id="further-processing" class="section level4">
<h4>Further processing</h4>
<p>Further processing on the command line can be done with the <code>[csvkit](http://csvkit.readthedocs.io/en/1.0.2/tricks.html#installation)</code> suite of tools.</p>
<p>This is an example:</p>
<pre><code>&lt;raw_tweets/stream_rstats.json jq  -s  -S \
&#39;[.[] | {name:  .user.name, sn: .user.screen_name, \
loc: .user.location, \
url:.user.url, \
desc:.user.description, \
_fol: .user.followers_count }]&#39;   | \
jq  -f -r to_csv.jq    | \
 csvsort -H -c 1    | csvcut -c 5,2 -l | csvlook --max-column-width 30 --max-rows 10
</code></pre>
<p>It produces this output:</p>
<p>(This table is not very informative, but that’s intentional. The content of the tweets is irrelevant here).</p>
<pre><code>| line_number | f                              | c              |
| ----------- | ------------------------------ | -------------- |
|           1 |                                | 日本 東京          |
|           2 |                                | Milan          |
|           3 |                                | Grand Ledge    |
|           4 |                                | Iowa City, IA  |
|           5 |                                | Pennsylvania   |
|           6 |                                | Columbus, OH   |
|           7 |                                | Columbus, OH   |
|           8 | http://es.linkedin.com/in/j... | Madrid - Spain |
|           9 |                                |                |
|          10 | http://personal.tcu.edu/kyl... | Fort Worth, TX |
|         ... | ...                            | ...            |</code></pre>
</div>
</div>

    </div>
  </article>

  

</main>

<!-- layouts/partials/footer.html //-->
      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
        </ul>
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-38728498-3"></script>


      </footer>

  
  



<script src="//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



  
<script src="/js/math-code.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>



<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/jquery.cookie.js"> </script>
<script src="/js/ekko-lightbox.js"></script>
<script src="/js/jquery.scrollTo.min.js"></script>
<script src="/js/masonry.pkgd.min.js"></script>
<script src="/js/imagesloaded.pkgd.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/front.js"></script>
<script src="/js/motto-fragments.js"></script>
<script src="/js/math-code.js"></script>
<script src="/js/modify-css.js"></script>

</body>
</html>